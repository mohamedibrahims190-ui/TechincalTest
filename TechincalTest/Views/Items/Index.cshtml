@model IEnumerable<TechincalTest.Models.Users>
@{
    ViewData["Title"] = "Items List";
}

<h1 class="fw-bold text-center mb-4">@ViewData["Title"]</h1>

<body style="background-color: #FEC437;">
    <div class="container py-5">

        <!-- Add New User Form -->
        <div class="row justify-content-center mb-4">
            <div class="col-md-8">
                <form id="createUserForm">
                    @Html.AntiForgeryToken()
                    <div class="row g-4 justify-content-center">

                        <!-- Name -->
                        <div class="col-sm-12 col-md-6">
                            <div class="form-floating mb-3">
                                <input name="Name" id="createName" class="form-control rounded-pill shadow-sm" placeholder="Enter Name" />
                                <label for="createName">Name</label>
                                <span id="createNameError" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Role -->
                        <div class="col-sm-12 col-md-6">
                            <div class="form-floating mb-3">
                                <input name="Role" id="createRole" class="form-control rounded-pill shadow-sm" placeholder="Enter Role" />
                                <label for="createRole">Role</label>
                                <span id="createRoleError" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 d-flex justify-content-center gap-3">
                        <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm px-5"
                                style="background: linear-gradient(135deg, #000068, #1c1c84); border: none; transition: transform 0.2s;">
                            Add
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Users Table -->
        <div class="table-responsive mb-5" style="max-height: 400px; overflow-y: auto; border-radius: 15px;">
            <table class="table table-striped shadow-lg mb-0">
                <thead class="bg-dark text-white" style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th style="border-top-left-radius: 15px;">Id</th>
                        <th>Name</th>
                        <th>Role</th>
                        <th style="border-top-right-radius: 15px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Id</td>
                            <td>@item.Name</td>
                            <td>@item.Role</td>
                            <td>
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-warning btn-sm rounded-pill mx-1">Edit</a>
                                <form asp-action="Delete" asp-route-id="@item.Id" method="post" class="d-inline" onsubmit="return confirm('Are you sure?');">
                                    <button type="submit" class="btn btn-danger btn-sm rounded-pill mx-1">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>


    </div>

    <script>
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const nameInput = document.getElementById('createName');
            const roleInput = document.getElementById('createRole');
            const nameError = document.getElementById('createNameError');
            const roleError = document.getElementById('createRoleError');

            nameError.textContent = '';
            roleError.textContent = '';

            const name = nameInput.value.trim();
            const role = roleInput.value.trim();

            let hasError = false;
            if (!name) { nameError.textContent = 'Name is required'; hasError = true; }
            if (!role) { roleError.textContent = 'Role is required'; hasError = true; }
            if (hasError) return;

            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const formData = new FormData();
            formData.append('Name', name);
            formData.append('Role', role);

            try {
                const response = await fetch('@Url.Action("Create", "Items")', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                const data = await response.json();

                if (!data.success) {
                    if (data.errors) {
                        if (data.errors.Name) nameError.textContent = data.errors.Name[0];
                        if (data.errors.Role) roleError.textContent = data.errors.Role[0];
                    }
                    return;
                }

                // Add new row to table
                const tableBody = document.querySelector('table tbody');
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${data.user.id}</td>
                    <td>${escapeHtml(data.user.name)}</td>
                    <td>${escapeHtml(data.user.role)}</td>
                    <td>
                        <a href="/Items/Edit/${data.user.id}" class="btn btn-warning btn-sm rounded-pill mx-1">Edit</a>
                        <form method="post" action="/Items/Delete/${data.user.id}" class="d-inline" onsubmit="return confirm('Are you sure?');">
                            <button type="submit" class="btn btn-danger btn-sm rounded-pill mx-1">Delete</button>
                        </form>
                    </td>
                `;
                tableBody.prepend(tr);

                // Clear inputs
                nameInput.value = '';
                roleInput.value = '';

            } catch (ex) {
                console.error(ex);
                alert('Network error');
            }
        });

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text && text !== 0) return '';
            return String(text).replace(/[&<>"']/g, function(m) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
            });
        }
    </script>
</body>
